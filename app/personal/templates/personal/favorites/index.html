{% extends "base.html" %}
{% block content %}
<div class="row g-3">
  <!-- Sidebar -->
  <div class="col-12 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h2 class="h6">Categories</h2>
        <div class="list-group list-group-flush">
          <a href="{{ url_for('favorites.index') }}"
             class="list-group-item list-group-item-action {{ 'active' if not active_cat else '' }}">
             All
          </a>
          {% for c in categories %}
            <a href="{{ url_for('favorites.index', category=c) }}"
               class="list-group-item list-group-item-action {{ 'active' if active_cat==c else '' }}">
               {{ c }}
            </a>
          {% endfor %}
        </div>

        <hr>

        {% if is_admin %}
          <!-- Add one URL -->
          <form class="d-grid gap-2" action="{{ url_for('favorites.add_one') }}" method="post">
            <label class="form-label small mb-1">Add one URL</label>
            <input class="form-control form-control-sm" name="url" placeholder="URL" required>
            <input class="form-control form-control-sm" name="alias" placeholder="Alias">
            <input class="form-control form-control-sm" name="category" placeholder="Category">
            <button class="btn btn-sm btn-success" type="submit">Add</button>
          </form>

          <hr>

          <!-- Import/Export -->
          <form class="d-grid gap-2" action="{{ url_for('favorites.import_csv') }}" method="post" enctype="multipart/form-data">
            <label class="form-label small">Import CSV</label>
            <input class="form-control form-control-sm" type="file" name="file" accept=".csv">
            <button class="btn btn-sm btn-primary" type="submit">Import</button>
          </form>
          <a class="btn btn-sm btn-outline-secondary mt-2 w-100"
             href="{{ url_for('favorites.export_csv') }}">Export CSV</a>
        {% else %}
          <div class="alert alert-info small mb-2">Login as admin to add or import.</div>

          <form class="d-grid gap-2" action="{{ url_for('favorites.add_one') }}" method="post">
            <label class="form-label small mb-1">Add one URL</label>
            <input class="form-control form-control-sm" name="url" placeholder="URL" required>
            <input class="form-control form-control-sm" name="alias" placeholder="Alias">
            <input class="form-control form-control-sm" name="category" placeholder="Category">
            <input class="form-control form-control-sm" name="remarks" placeholder="Remarks (optional)">
            <button class="btn btn-sm btn-success" type="submit">Add</button>
          </form>

          <hr>

          <form class="d-grid gap-2">
            <label class="form-label small">Import CSV</label>
            <input class="form-control form-control-sm" type="file" disabled>
            <button class="btn btn-sm btn-primary" disabled>Import</button>
          </form>
          <a class="btn btn-sm btn-outline-secondary mt-2 w-100 disabled" role="button" aria-disabled="true">Export CSV</a>
        {% endif %}

        <div class="mt-3 small text-muted">
          Headers: <code>URL, Alias, Category</code>
        </div>
      </div>
    </div>
  </div>

  <!-- Main -->
  <div class="col-12 col-md-9">
    <div class="d-flex justify-content-between align-items-center mb-2">
  <h1 class="h5 m-0">Favorites</h1>
  <div class="input-group input-group-sm" style="width: 100%;">
    <input id="searchBox" type="text" class="form-control"
           placeholder="Type to search (real-time)">
    <button type="button" class="btn btn-outline-primary" onclick="copySelectedUrls()">
      Copy Selected
    </button>
  </div>
</div>



    <div class="card shadow-sm">
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0" id="favoritesTable">
          <thead class="table-light">
  <tr>
    <!-- 1) Category (sortable) -->
    {% set next_order_cat = 'desc' if (sort=='category' and order=='asc') else 'asc' %}
    <th>
      <a class="text-decoration-none"
         href="{{ url_for('favorites.index', category=active_cat, sort='category', order=next_order_cat) }}">
        Category
        {% if sort == 'category' %}
          <i class="bi {{ 'bi-caret-up-fill' if order=='asc' else 'bi-caret-down-fill' }}"></i>
        {% endif %}
      </a>
    </th>

    <!-- 2) Alias (sortable) -->
    {% set next_order_alias = 'desc' if (sort=='alias' and order=='asc') else 'asc' %}
    <th>
      <a class="text-decoration-none"
         href="{{ url_for('favorites.index', category=active_cat, sort='alias', order=next_order_alias) }}">
        Alias
        {% if sort == 'alias' %}
          <i class="bi {{ 'bi-caret-up-fill' if order=='asc' else 'bi-caret-down-fill' }}"></i>
        {% endif %}
      </a>
    </th>

    <!-- 3) Copy (no heading) -->
    <th style="width:1%"></th>

    <!-- 4) Select (checkbox header with Select All) -->
    <th style="width:1%; text-align:center;">
      <input type="checkbox" id="selectAll" onclick="toggleAll(this)">
    </th>

    <!-- 5) Remarks -->
    <th>Remarks</th>
  </tr>
</thead>


          <tbody>
  {% for r in rows %}
    <tr>
      <!-- 1) Category -->
      <td>{{ r.category or '—' }}</td>

      <!-- 2) Alias -->
      <td>
        {% if r.url %}
          <a href="{{ r.url }}" target="_blank" rel="noopener">{{ r.alias or r.url }}</a>
        {% else %}
          {{ r.alias or '—' }}
        {% endif %}
      </td>

      <!-- 3) Copy button (after Alias) -->
      <td>
        {% if r.url %}
          <button type="button" class="btn btn-sm btn-outline-secondary"
                  onclick="copyOneUrl('{{ r.url }}')">
            Copy
          </button>
        {% endif %}
      </td>

      <!-- 4) Visible checkbox -->
      <td class="text-center">
        {% if r.url %}
          <input type="checkbox" class="row-check" data-url="{{ r.url }}">
        {% endif %}
      </td>

      <!-- 5) Remarks -->
      <td>{{ r.remarks or '—' }}</td>
    </tr>
  {% else %}
    <tr>
      <td colspan="5" class="text-center text-muted">
        No data. Add one URL or import a CSV to get started.
      </td>
    </tr>
  {% endfor %}
</tbody>




        </table>
      </div>
    </div>
  </div>
</div>

<!-- Live search -->
<script>
function toggleAll(cb){
  document.querySelectorAll('.row-check').forEach(x => { x.checked = cb.checked; });
}

function copyOneUrl(url){
  if(!url) return;
  navigator.clipboard.writeText(url);
}

function copySelectedUrls(){
  const urls = Array.from(document.querySelectorAll('.row-check:checked'))
    .map(cb => cb.getAttribute('data-url'))
    .filter(Boolean);
  if(urls.length === 0){
    alert("No URLs selected.");
    return;
  }
  navigator.clipboard.writeText(urls.join(', ')).then(() => {
    alert("Copied " + urls.length + " URL(s).");
  });
}

// Live search (unchanged)
document.getElementById("searchBox").addEventListener("keyup", function(){
  const q = this.value.toLowerCase();
  const rows = document.querySelectorAll("#favoritesTable tbody tr");
  rows.forEach(row => {
    row.style.display = row.innerText.toLowerCase().includes(q) ? "" : "none";
  });
});
</script>





{% endblock %}
